---
title: 'Statistical Methods for Discrete Response, Time Series, and Panel Data (W271): Lab 2'
subtitle: 'Due Monday July 12 2021 11:59pm'
geometry: margin=1in
output:
  pdf_document:
    latex_engine: xelatex
  number_sections: yes
  html_document: default
  toc: yes
fontsize: 11pt
---
```{r include=FALSE}
# Insert the function to *tidy up* the code when they are printed out
library(knitr)
opts_chunk$set(tidy.opts=list(width.cutoff=60),tidy=TRUE)

# Load libraries
library(forecast)
library(lubridate)
library(fable)
library(fpp2)
library(fpp3)
library(astsa)
library(dplyr)
library(Hmisc)
library(feasts)
library(seasonal)

#for displaying time series with NA
library(imputeTS)
```
# The Keeling Curve

In the 1950s, the geochemist Charles David Keeling observed a seasonal pattern in the amount of carbon dioxide present in air samples collected over the course of several years. He attributed this pattern to varying rates of photosynthesis throughout the year, caused by differences in land area and vegetation cover between the Earth's northern and southern hemispheres.

In 1958 Keeling began continuous monitoring of atmospheric carbon dioxide concentrations from the Mauna Loa Observatory in Hawaii. He soon observed a trend increase carbon dioxide levels in addition to the seasonal cycle, attributable to growth in global rates of fossil fuel combustion. Measurement of this trend at Mauna Loa has continued to the present.

The `co2` data set in R's `datasets` package (automatically loaded with base R) is a monthly time series of atmospheric carbon dioxide concentrations measured in ppm (parts per million) at the Mauna Loa Observatory from 1959 to 1997. The curve graphed by this data is known as the 'Keeling Curve'.

```{r}
plot(co2, ylab = expression("CO2 ppm"), col = 'blue', las = 1)
title(main = "Monthly Mean CO2 Variation")
```

\newpage

**Part 1 (3 points)**

Conduct a comprehensive Exploratory Data Analysis on the `co2` series. This should include (without being limited to) a thorough investigation of the trend, seasonal and irregular elements. 

**Part 2 (3 points)**

Fit a linear time trend model to the `co2` series, and examine the characteristics of the residuals. Compare this to a higher-order polynomial time trend model. Discuss whether a logarithmic transformation of the data would be appropriate. Fit a polynomial time trend model that incorporates seasonal dummy variables, and use this model to generate forecasts up to the present. 

**Part 3 (4 points)**

Following all appropriate steps, choose an ARIMA model to fit to this `co2` series. Discuss the characteristics of your model and how you selected between alternative ARIMA specifications. Use your model to generate forecasts to the present. 

**Part 4 (5 points)**

The file `co2_weekly_mlo.txt` contains weekly observations of atmospheric carbon dioxide concentrations measured at the Mauna Loa Observatory from 1974 to 2020, published by the National Oceanic and Atmospheric Administration (NOAA). Convert these data into a suitable time series object, conduct a thorough EDA on the data, addressing the problem of missing observations and comparing the Keeling Curve's development to your predicitons from Parts 2 and 3. Use the weekly data to generate a month-average series from 1997 to the present and use this to generate accuracy metrics for the forecasts generated by your models from Parts 2 and 3. 
 
```{r}
# load data
noaa <- read.table("co2_weekly_mlo.txt", comment.char="#", header=FALSE)
noaa$date <- as.Date(with(noaa, paste(V1,V2,V3, sep="-")), "%Y-%m-%d")
noaa.converted <- noaa %>% mutate(CO2=V5, DATE=date) %>% select(CO2, DATE)
describe(noaa.converted)
plot(noaa.converted$DATE, noaa.converted$CO2)
```
It looks like there are multiple observations with incorrect observations. 
```{r}
noaa.incorrect <- noaa.converted[noaa.converted$CO2<0, ]
head(noaa.incorrect)
describe(noaa.incorrect)
```
Let's also check if there are any missing week.
```{r}
start.week <- noaa.converted$DATE[1]
end.week <- tail(noaa.converted$DATE,1)
full.week.list <- seq.Date(start.week, end_week, by=7)
has.all.weeks <- all(full.week.list == noaa.converted$DATE)
print(has.all.weeks)
```
It looks like there are no missing weeks. 

There are 18 observations with CO2 reading of -999. Let's visualize them.
```{r}
noaa.converted$CO2 <- ifelse(noaa.converted$CO2<0, NA, noaa.converted$CO2)

#noaa.ts <- xts(noaa.converted$CO2, order.by=noaa.converted$DATE)
noaa.ts <- ts(noaa.converted$CO2, start=c(1974,5,19), frequency=52.18)
  
ggplot_na_distribution(noaa.ts )
```
We can try imputing the data with the last observation carrid forward method.
```{r}
noaa.ts.imputed.locf <- na_locf(noaa.ts)
noaa.ts.imputed.locf.tsibble <- as_tsibble(noaa.ts.imputed.locf)

```

Let's visualize the imputed time series.
```{r}
ggplot_na_distribution(noaa.ts.imputed.locf.tsibble)
```
There are no missing values.

## EDA on weekly data

```{r}
noaa.ts.imputed.locf.tsibble %>% gg_tsdisplay(y=value , plot="partial", lag_max=32)
```
Time series graph shows a clear upward trend and seasonal pattern. Both ACF and PACF Correlograms confirm this finding. 
```{r}
noaa.ts.imputed.locf.tsibble %>% gg_season(y=value) + ggtitle("Seasonal plot of CO2 levels using weekly time series")
```
As shown graph, CO2 level is definitely increasing every year. There is an obvious seasonal pattern -- CO2 level goes down from January to June but goes back up from June to December. Since the magnitude of the seasonal fluctuation does not vary with the level of time series, an addictive seasonal pattern should be more appropriate than a multiplicative seasonal pattern.

## EDA on Monthly data
Let's convert weekly data to monthly.

```{r}
noaa.converted$month <- floor_date(noaa.converted$DATE, "month")
nova.monthly <- noaa.converted %>% group_by(month) %>% dplyr::summarize(mean = mean(CO2))
nova.monthly.ts <- as_tsibble(ts(nova.monthly$mean, start=c(1974,5), frequency=12))
nova.monthly.ts <- na_locf(nova.monthly.ts)
```

```{r}
nova.monthly.ts %>% gg_tsdisplay(y=value, plot="partial", lag_max=32)
```
As expected, monthly time series graph shows upwards trends and seasonal trends. Both ACF and PACF correlograms confirm this finding. Let's 
```{r}
nova.monthly.ts %>% gg_season(y=value) + ggtitle("Seasonal plot of CO2 levels using monthly time series")
```
As shown graph, CO2 level is definitely increasing every year. There is an clear cyclic seasonal pattern -- CO2 level goes up from January to May, goes down from MAy to September, and then goes back up from September to December. Since the magnitude of the seasonal fluctuation does not vary with the level of time series, an addictive seasonal pattern should be more appropriate than a multiplicative seasonal pattern.

Let's decompose time series into trend, seasonal and irregular components.
```{r}
nova.monthly.ts %>% model(x11=feasts:::X11(value, type="additive")) %>% components() %>% autoplot()
```

In addition to the decomposition, we can apply Box-Cox transformation to stablize the variance.

```{r}
#choose lambda using guerrero's method
lambda <- nova.monthly.ts %>% features(value, features=guerrero) %>% pull(lambda_guerrero)
#print(lambda)
#apply Box-Cox transformation with a chosen lambda
nova.monthly.ts.boxcox <- nova.monthly.ts %>% mutate(value_bc = box_cox(value, lambda=lambda))

#log-transformation
#nova.monthly.ts.boxcox %>% autoplot(log(value), color="pink") + autolayer(nova.monthly.ts.boxcox, value_bc) + ggtitle("Transformed CO2 level series")

```

Let's apply decomposition again using the transformed values:
```{r}
nova.monthly.ts.boxcox %>% model(x11=feasts:::X11(value_bc, type="additive")) %>% components() %>% autoplot()

```

**Part 5 (5 points)**

Split the NOAA series into training and test sets, using the final two years of observations as the test set. Fit an ARIMA model to the series following all appropriate steps, including comparison of how candidate models perform both in-sample and (psuedo-) out-of-sample. Generate predictions for when atmospheric CO2 is expected to reach 450 parts per million, considering the prediction intervals as well as the point estimate. Generate a prediction for atmospheric CO2 levels in the year 2100. How confident are you that these will be accurate predictions?

Let's split the NOAA series into training and test sets, taking the final two years as test set period for measuring pseudo out-of-sample forecasting performance.

```{r}
noaa.training <- nova.monthly.ts.boxcox %>% filter_index(~"2019 May")
noaa.test <- nova.monthly.ts.boxcox %>% filter_index("2019 June"~.) 

noaa.training %>% autoplot(value) + autolayer(noaa.test, colour="red") + ggtitle("CO2 level time series")

```

Black and red lines represent training and test sets, respectively. Let's apply the log-transform first-differencing to the box-cox transformed series to stabilize the mean.
```{r}
noaa.training <- noaa.training %>% mutate(d_value = difference(value_bc,1))
noaa.training %>% gg_tsdisplay(y=d_value, plot="partial", lag_max=32)
```

After the log-transformation and first-differencing, time series do not seem to have the upward trend but it still has a seasonal pattern. Let's apply the seasonal differencing to eliminate seasonality.

```{r}
noaa.training <- noaa.training %>% mutate(sd_value = difference(value_bc,12))
noaa.training %>% gg_tsdisplay(y=sd_value, plot="partial", lag_max=32)
noaa.training$sd_value %>% gghistogram()
```

We applied the difference at a frequency of 12 since we are using a monthly data. Seasonality seems to be largely subdued. Let's apply KPSS unit root test to check the stationairty.
```{r}
noaa.training %>% features(sd_value, unitroot_kpss)
```
Under the KPSS unit root test, null hypotheses of stationarity would be rejected at 1% of significance.

Let's apply both seasonal and nonseasonal differencing.
```{r}
noaa.training <- noaa.training %>% mutate(d_sd_value = difference(sd_value))
noaa.training %>% gg_tsdisplay(y=d_sd_value, plot="partial", lag_max=32) 
noaa.training$d_sd_value %>% gghistogram()
noaa.training %>% features(d_sd_value, unitroot_kpss)
```

Applying both seasonal and nonseasonal differencing seem to give more stationary series. P-value for KPSS test is 0.1. At alpha=0.05, we would not reject the null hypothesis of stationarity. 

The correlogram of the first and seasonal-differened series shows significant spikes in ACF and PACF at lag 12, potentially suggesting a seasonal MA(1) and/or AR component. We can perform exhaustive search to find the best performing model.
```{r}

```


